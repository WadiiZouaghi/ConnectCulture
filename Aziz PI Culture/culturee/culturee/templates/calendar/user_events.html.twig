{% extends 'base.html.twig' %}

{% block title %}My Events Calendar{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link href='https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.1/css/all.css' rel='stylesheet'>
<link href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet'>
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet'>
<style>
    .fc { /* the calendar root */
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px;
    }

    #calendar-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        margin: 20px auto;
        max-width: 1200px;
    }

    .fc-toolbar-title {
        font-size: 1.5em !important;
        color: #062264;
    }

    .fc-button-primary {
        background-color: #062264 !important;
        border-color: #062264 !important;
    }

    .fc-button-primary:hover {
        background-color: #4b93d1 !important;
        border-color: #4b93d1 !important;
    }

    .fc-daygrid-day {
        cursor: pointer;
    }

    .fc-event {
        cursor: pointer;
        padding: 5px;
        margin: 2px 0;
        border-radius: 4px;
    }

    .system-info-box {
        background: white;
        padding: 15px;
        margin: 20px auto;
        max-width: 1200px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .system-info-item {
        color: #062264;
        font-size: 0.9rem;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }

    .system-info-item i {
        margin-right: 10px;
        color: #4b93d1;
    }

    .event-details {
        padding: 15px;
    }

    .event-details h4 {
        color: #062264;
        margin-bottom: 15px;
    }

    .event-details p {
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <!-- System Info Box -->
    <div class="system-info-box">
        <div class="row">
            <div class="col-md-6">
                <div class="system-info-item">
                    <i class="fas fa-clock"></i>
                    <span id="current-datetime"></span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="system-info-item">
                    <i class="fas fa-user"></i>
                    <span>{{ app.user.userIdentifier }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Container -->
    <div id="calendar-container">
        <div id="calendar"></div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetails">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="eventDetailsLink" class="btn btn-primary">View Details</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update datetime
    function updateDateTime() {
        const now = new Date();
        const formatted = now.getUTCFullYear() + '-' + 
                         String(now.getUTCMonth() + 1).padStart(2, '0') + '-' + 
                         String(now.getUTCDate()).padStart(2, '0') + ' ' + 
                         String(now.getUTCHours()).padStart(2, '0') + ':' + 
                         String(now.getUTCMinutes()).padStart(2, '0') + ':' + 
                         String(now.getUTCSeconds()).padStart(2, '0');
        document.getElementById('current-datetime').textContent = 'Current Date and Time (UTC): ' + formatted;
    }
    
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Initialize calendar
    var calendarEl = document.getElementById('calendar');
    var eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        themeSystem: 'bootstrap5',
        events: {{ events|raw }},
        eventClick: function(info) {
            const event = info.event;
            
            // Format the event details
            document.getElementById('eventDetails').innerHTML = `
                <div class="event-details">
                    <h4>${event.title}</h4>
                    <p><strong><i class="fas fa-calendar"></i> Date:</strong> ${new Date(event.start).toLocaleString()}</p>
                    <p><strong><i class="fas fa-map-marker-alt"></i> Location:</strong> ${event.extendedProps.location || 'TBD'}</p>
                    <p><strong><i class="fas fa-tag"></i> Type:</strong> ${event.extendedProps.eventtype || 'Not specified'}</p>
                    <p><strong><i class="fas fa-users"></i> Available Places:</strong> ${event.extendedProps.nbplaces}</p>
                    <p><strong><i class="fas fa-info-circle"></i> Description:</strong> ${event.extendedProps.description || 'No description available'}</p>
                    ${event.extendedProps.equipment ? `
                        <p><strong><i class="fas fa-tools"></i> Required Equipment:</strong> ${event.extendedProps.equipment}</p>
                    ` : ''}
                </div>
            `;

            // Update the view details link
            document.getElementById('eventDetailsLink').href = `/event/${event.id}/show`;
            
            // Show the modal
            eventModal.show();
        },
        eventDidMount: function(info) {
            // Add tooltips to events
            new bootstrap.Tooltip(info.el, {
                title: info.event.title,
                placement: 'top',
                trigger: 'hover',
                container: 'body'
            });
        }
    });

    calendar.render();
});
</script>
{% endblock %}